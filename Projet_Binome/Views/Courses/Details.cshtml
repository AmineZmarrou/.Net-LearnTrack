@using System.Globalization
@model Projet_Binome.Models.ViewModels.CourseDetailsViewModel

@{
    ViewData["Title"] = "Course Details";
    var origin = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
}

@functions {
    private string? BuildEmbedUrl(string? link)
    {
        if (string.IsNullOrWhiteSpace(link))
        {
            return null;
        }

        link = link.Trim();

        if (link.Contains("youtube.com/embed/", StringComparison.OrdinalIgnoreCase) ||
            link.Contains("youtube-nocookie.com/embed/", StringComparison.OrdinalIgnoreCase))
        {
            return link;
        }

        string? videoId = null;
        string? playlistId = null;

        const string shortHost = "youtu.be/";
        var shortIndex = link.IndexOf(shortHost, StringComparison.OrdinalIgnoreCase);
        if (shortIndex >= 0)
        {
            var start = shortIndex + shortHost.Length;
            var end = link.IndexOfAny(new[] { '?', '&', '#' }, start);
            if (end == -1) end = link.Length;
            videoId = link.Substring(start, end - start);
        }
        else
        {
            const string marker = "v=";
            var markerIndex = link.IndexOf(marker, StringComparison.OrdinalIgnoreCase);
            if (markerIndex >= 0)
            {
                var start = markerIndex + marker.Length;
                var end = link.IndexOfAny(new[] { '&', '?', '#' }, start);
                if (end == -1) end = link.Length;
                videoId = link.Substring(start, end - start);
            }
        }

        const string listMarker = "list=";
        var listIndex = link.IndexOf(listMarker, StringComparison.OrdinalIgnoreCase);
        if (listIndex >= 0)
        {
            var start = listIndex + listMarker.Length;
            var end = link.IndexOfAny(new[] { '&', '?', '#' }, start);
            if (end == -1) end = link.Length;
            playlistId = link.Substring(start, end - start);
        }

        if (string.IsNullOrWhiteSpace(videoId) && string.IsNullOrWhiteSpace(playlistId))
        {
            return null;
        }

        if (!string.IsNullOrWhiteSpace(videoId))
        {
            var url = $"https://www.youtube.com/embed/{videoId}";
            if (!string.IsNullOrWhiteSpace(playlistId))
            {
                url += $"?list={playlistId}";
            }
            return url;
        }

        return $"https://www.youtube.com/embed/videoseries?list={playlistId}";
    }

    private string AppendQuery(string url, string query)
    {
        if (url.Contains("?", StringComparison.Ordinal))
        {
            return $"{url}&{query}";
        }

        return $"{url}?{query}";
    }
}

@if (isAuthenticated)
{
    <form id="lesson-progress-token" class="d-none">
        @Html.AntiForgeryToken()
    </form>
}

<section class="page-hero">
    <div class="container">
        <div class="row align-items-center g-4">
            <div class="col-lg-7">
                <p class="eyebrow">Course</p>
                <h1 class="display-5 fw-bold">@Model.Course.Title</h1>
                <p class="text-muted mb-3">@Model.Course.Description</p>
                <div class="d-flex flex-wrap gap-2 mb-4">
                    <span class="pill">Lessons: @(Model.Course.Lessons?.Count ?? 0)</span>
                    @if (Model.Course.Quiz != null)
                    {
                        <span class="pill">Quiz included</span>
                    }
                </div>
                <div class="d-flex flex-wrap gap-2">
                    @if (Model.Course.Quiz != null)
                    {
                        <a asp-controller="Quizzes" asp-action="TakeQuiz" asp-route-id="@Model.Course.Quiz.Id" class="btn btn-primary btn-lg">Start Quiz</a>
                    }
                    <a class="btn btn-outline-secondary btn-lg" asp-action="Index">Retour au catalogue</a>
                </div>
            </div>
            <div class="col-lg-5">
                @if (!string.IsNullOrWhiteSpace(Model.Course.ImageUrl))
                {
                    <div class="image-frame">
                        <img src="@Model.Course.ImageUrl" alt="@Model.Course.Title">
                    </div>
                }
                else
                {
                    <div class="image-frame image-placeholder">
                        <span class="text-muted">No image available</span>
                    </div>
                }
            </div>
        </div>
    </div>
</section>

<section class="home-section">
    <div class="container">
        <div class="section-heading">
            <p class="eyebrow">Lessons</p>
            <h2 class="fw-bold">Watch and learn</h2>
            <p class="text-muted">Resume any lesson from where you left off.</p>
        </div>
        <div class="row g-4">
            @foreach (var lesson in Model.Course.Lessons)
            {
                var embedUrl = BuildEmbedUrl(lesson.YouTubeLink);
                var progress = Model.LessonProgress.TryGetValue(lesson.Id, out var entry) ? entry : null;
                var lastPosition = progress?.LastPositionSeconds ?? 0;
                var progressPercent = progress?.PercentComplete ?? 0;
                var progressLabel = progressPercent > 0 ? $"{progressPercent:0}%" : "Not started";
                <div class="col-lg-6">
                    <div class="card lesson-card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start gap-3 mb-2">
                                <h5 class="card-title mb-0">@lesson.Title</h5>
                                @if (isAuthenticated)
                                {
                                    <span class="badge lesson-pill">@progressLabel</span>
                                }
                            </div>
                            <p class="card-text text-muted">@lesson.Content</p>
                            @if (!string.IsNullOrWhiteSpace(embedUrl))
                            {
                                var playerUrl = AppendQuery(embedUrl, $"enablejsapi=1&origin={System.Uri.EscapeDataString(origin)}");
                                <div class="ratio ratio-16x9 mb-3">
                                    <iframe id="lesson-player-@lesson.Id"
                                            class="lesson-player"
                                            src="@playerUrl"
                                            title="@lesson.Title"
                                            loading="lazy"
                                            data-lesson-id="@lesson.Id"
                                            data-last-position="@lastPosition.ToString("0.###", CultureInfo.InvariantCulture)"
                                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                                            allowfullscreen></iframe>
                                </div>
                            }
                            else
                            {
                                <div class="text-muted small mb-3">Lien video indisponible pour cet element.</div>
                            }
                            <div class="lesson-actions">
                                <a class="btn btn-outline-secondary btn-sm" href="@lesson.YouTubeLink" target="_blank">Ouvrir sur YouTube</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</section>

@if (Model.Course.Quiz != null)
{
    <section class="home-section">
        <div class="container">
            <div class="cta-card cta-card--split">
                <div>
                    <h2 class="fw-bold mb-2">Ready for the quiz?</h2>
                    <p class="text-muted mb-0">Score 70% or higher to unlock your certificate.</p>
                </div>
                <a asp-controller="Quizzes" asp-action="TakeQuiz" asp-route-id="@Model.Course.Quiz.Id" class="btn btn-primary btn-lg">Start Quiz</a>
            </div>
        </div>
    </section>
}

@section Scripts {
    @if (isAuthenticated)
    {
        <script src="https://www.youtube.com/iframe_api"></script>
        <script>
            (function () {
                const progressUrl = '@Url.Action("UpdateLessonProgress", "Courses")';
                const token = document.querySelector('#lesson-progress-token input[name="__RequestVerificationToken"]')?.value;
                const players = new Map();
                const activeIntervals = new Map();
                const updateIntervalMs = 10000;

                if (!progressUrl || !token) {
                    return;
                }

                function sendProgress(lessonId, player) {
                    if (!player || typeof player.getCurrentTime !== 'function') {
                        return;
                    }

                    const duration = player.getDuration();
                    const currentTime = player.getCurrentTime();
                    if (!Number.isFinite(duration) || duration <= 0) {
                        return;
                    }

                    const payload = {
                        lessonId: lessonId,
                        currentTimeSeconds: currentTime,
                        durationSeconds: duration
                    };

                    fetch(progressUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify(payload),
                        keepalive: true
                    });
                }

                function startTracking(lessonId, player) {
                    if (activeIntervals.has(lessonId)) {
                        return;
                    }

                    const intervalId = window.setInterval(function () {
                        sendProgress(lessonId, player);
                    }, updateIntervalMs);

                    activeIntervals.set(lessonId, intervalId);
                }

                function stopTracking(lessonId) {
                    const intervalId = activeIntervals.get(lessonId);
                    if (intervalId) {
                        window.clearInterval(intervalId);
                        activeIntervals.delete(lessonId);
                    }
                }

                function flushAllProgress() {
                    players.forEach(function (player, lessonId) {
                        sendProgress(lessonId, player);
                        stopTracking(lessonId);
                    });
                }

                window.onYouTubeIframeAPIReady = function () {
                    document.querySelectorAll('.lesson-player').forEach(function (iframe) {
                        const lessonId = Number(iframe.dataset.lessonId);
                        const lastPosition = Number(iframe.dataset.lastPosition || 0);

                        const player = new YT.Player(iframe.id, {
                            events: {
                                onReady: function (event) {
                                    if (Number.isFinite(lastPosition) && lastPosition > 1) {
                                        event.target.seekTo(lastPosition, true);
                                    }
                                },
                                onStateChange: function (event) {
                                    if (event.data === YT.PlayerState.PLAYING) {
                                        startTracking(lessonId, event.target);
                                    } else if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
                                        sendProgress(lessonId, event.target);
                                        stopTracking(lessonId);
                                    }
                                }
                            }
                        });

                        players.set(lessonId, player);
                    });
                };

                window.addEventListener('pagehide', flushAllProgress);
                document.addEventListener('visibilitychange', function () {
                    if (document.visibilityState === 'hidden') {
                        flushAllProgress();
                    }
                });
            })();
        </script>
    }
}
